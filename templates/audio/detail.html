{% extends 'base.html' %} {% block title %}ë¶„ì„ ê²°ê³¼ ë³´ì • - LinguaTech{% endblock %} {% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="fw-bold mb-1">ğŸ“ í™”ì ë¶„ë¦¬ ë³´ì •</h4>
            <p class="text-muted mb-0" id="fileName">ë¡œë”© ì¤‘...</p>
        </div>
        <div>
            <button onclick="saveChanges()" class="btn btn-primary btn-lg shadow-sm">ğŸ’¾ ì €ì¥ ë° ì™„ë£Œ</button>
        </div>
    </div>

    <div class="alert alert-info border-0 bg-info-subtle text-info-emphasis mb-4">
        <i class="bi bi-info-circle-fill me-2"></i>
        <strong>ì‚¬ìš© ë°©ë²•:</strong>
        1. <u>ìƒë‹´ì‚¬</u>ê°€ ë§í•œ êµ¬ê°„ì€ ì²´í¬ë°•ìŠ¤ë¥¼ ì¼œì£¼ì„¸ìš”.<br />
        2. ì˜¤íƒ€ë‚˜ ì˜ëª»ëœ ë‚´ìš©ì€ í…ìŠ¤íŠ¸ ë°•ìŠ¤ë¥¼ í´ë¦­í•˜ì—¬ ì§ì ‘ <u>ìˆ˜ì •</u>í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-header bg-white py-3 border-bottom">
            <div class="row fw-bold text-secondary text-center align-items-center">
                <div class="col-1">ìƒë‹´ì‚¬?</div>
                <div class="col-2">ì‹œê°„</div>
                <div class="col-9 text-start ps-3">ë°œì–¸ ë‚´ìš© (í´ë¦­í•˜ì—¬ ìˆ˜ì •)</div>
            </div>
        </div>
        <div class="card-body p-0">
            <div id="segmentList" class="list-group list-group-flush">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2 text-muted">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const SESSION_ID = '{{ session_id }}';
</script>
{% endblock %} {% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        loadDetail();
    });

    // 1. ìƒì„¸ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadDetail() {
        const token = localStorage.getItem('access_token');
        if (!token) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = '/login';
            return;
        }

        try {
            const response = await fetch(`/api/audio/${SESSION_ID}`, {
                headers: { Authorization: `Bearer ${token}` },
            });

            if (!response.ok) throw new Error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');

            const data = await response.json();

            // ğŸ‘‡ ì—¬ê¸°ì„œ id="fileName" ìš”ì†Œë¥¼ ì°¾ì•„ í…ìŠ¤íŠ¸ë¥¼ ë„£ìŠµë‹ˆë‹¤.
            const fileNameEl = document.getElementById('fileName');
            if (fileNameEl) {
                fileNameEl.innerText = data.file_name;
            }

            renderSegments(data.segments);
        } catch (error) {
            console.error(error);
            alert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // 2. í™”ë©´ ê·¸ë¦¬ê¸° (ë¦¬ìŠ¤íŠ¸ ë Œë”ë§)
    function renderSegments(segments) {
        const container = document.getElementById('segmentList');

        if (segments.length === 0) {
            container.innerHTML = `<div class="text-center py-5 text-muted">ë¶„ì„ëœ í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
            return;
        }

        let html = '';
        segments.forEach((seg) => {
            const startFmt = formatTime(seg.start_time);
            const endFmt = formatTime(seg.end_time);
            const isCounselor = seg.speaker_label === 'counselor';
            const checkedAttr = isCounselor ? 'checked' : '';
            const rowClass = isCounselor ? 'bg-primary-subtle bg-opacity-10' : '';

            html += `
                <div class="list-group-item list-group-item-action ${rowClass} segment-row" 
                     data-id="${seg.id}" id="row-${seg.id}">
                    
                    <div class="row align-items-center">
                        <div class="col-1 text-center">
                            <input type="checkbox" class="form-check-input speaker-checkbox" 
                                   style="transform: scale(1.3); cursor: pointer;"
                                   ${checkedAttr}
                                   onchange="toggleRowColor(${seg.id}, this.checked)">
                        </div>
                        
                        <div class="col-2 text-muted small text-center">
                            ${startFmt} ~ ${endFmt}
                        </div>
                        
                        <div class="col-9">
                            <textarea class="form-control border-0 bg-transparent text-input" 
                                      rows="1" 
                                      style="resize: none; overflow: hidden; box-shadow: none;"
                                      oninput="autoResize(this)">${seg.text}</textarea>
                        </div>
                    </div>
                </div>
            `;
        });
        container.innerHTML = html;

        // ë Œë”ë§ ì§í›„, í…ìŠ¤íŠ¸ ê¸¸ì´ì— ë§ì¶° ë†’ì´ ìë™ ì¡°ì ˆ
        document.querySelectorAll('.text-input').forEach((el) => autoResize(el));
    }

    // 3. í…ìŠ¤íŠ¸ ë°•ìŠ¤ ë†’ì´ ìë™ ì¡°ì ˆ í•¨ìˆ˜
    function autoResize(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
    }

    // 4. ì²´í¬ë°•ìŠ¤ í´ë¦­ ì‹œ ë°°ê²½ìƒ‰ í† ê¸€
    window.toggleRowColor = function (id, isChecked) {
        const row = document.getElementById(`row-${id}`);
        if (isChecked) {
            row.classList.add('bg-primary-subtle', 'bg-opacity-10');
        } else {
            row.classList.remove('bg-primary-subtle', 'bg-opacity-10');
        }
    };

    // 5. ë³€ê²½ ì‚¬í•­ ì €ì¥ (í™”ì ì •ë³´ + í…ìŠ¤íŠ¸ ìˆ˜ì •)
    async function saveChanges() {
        const token = localStorage.getItem('access_token');

        // í™”ë©´ì˜ ëª¨ë“  row ë°ì´í„°ë¥¼ ìˆ˜ì§‘
        const rows = document.querySelectorAll('.segment-row');
        const updateData = [];

        rows.forEach((row) => {
            const id = parseInt(row.getAttribute('data-id'));
            const isChecked = row.querySelector('.speaker-checkbox').checked;
            const textValue = row.querySelector('.text-input').value; // ìˆ˜ì •ëœ í…ìŠ¤íŠ¸

            updateData.push({
                id: id,
                text: textValue,
                is_counselor: isChecked,
            });
        });

        try {
            const response = await fetch(`/api/audio/${SESSION_ID}/confirm`, {
                method: 'POST',
                headers: {
                    Authorization: `Bearer ${token}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ segments: updateData }),
            });

            if (response.ok) {
                const resData = await response.json();
                alert(`âœ… ì €ì¥ ì™„ë£Œ! (${resData.updated_count}ê°œ í•­ëª© ìˆ˜ì •ë¨)`);
                window.location.href = '/'; // ë©”ì¸ìœ¼ë¡œ ì´ë™
            } else {
                alert('ì €ì¥ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        } catch (error) {
            console.error(error);
            alert('ì„œë²„ í†µì‹  ì˜¤ë¥˜');
        }
    }

    // 6. ì‹œê°„ í¬ë§·íŒ… (ì´ˆ -> 00:00)
    function formatTime(seconds) {
        const m = Math.floor(seconds / 60);
        const s = Math.floor(seconds % 60);
        return `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
    }
</script>
{% endblock %}
