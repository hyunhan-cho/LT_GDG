{% extends 'base.html' %} {% block title %}ë¶„ì„ ê²°ê³¼ ë³´ì • - LinguaTech{% endblock %} {% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="fw-bold mb-1">ğŸ“ í™”ì ë¶„ë¦¬ ë³´ì •</h4>
            <p class="text-muted mb-0" id="fileName">ë¡œë”© ì¤‘...</p>
        </div>
        <div>
            <button onclick="saveChanges()" class="btn btn-primary btn-lg shadow-sm">ğŸ’¾ ì €ì¥ ë° ì™„ë£Œ</button>
        </div>
    </div>

    <div class="alert alert-info border-0 bg-info-subtle text-info-emphasis mb-4">
        <i class="bi bi-info-circle-fill me-2"></i>
        <strong>ì‚¬ìš© ë°©ë²•:</strong>
        1. <u>ìƒë‹´ì‚¬</u>ê°€ ë§í•œ êµ¬ê°„ì€ ì²´í¬ë°•ìŠ¤ë¥¼ ì¼œì£¼ì„¸ìš”.<br />
        2. ì˜¤íƒ€ë‚˜ ì˜ëª»ëœ ë‚´ìš©ì€ í…ìŠ¤íŠ¸ ë°•ìŠ¤ë¥¼ í´ë¦­í•˜ì—¬ ì§ì ‘ <u>ìˆ˜ì •</u>í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-header bg-white py-3 border-bottom">
            <div class="row fw-bold text-secondary text-center align-items-center">
                <div class="col-1">ìƒë‹´ì‚¬?</div>
                <div class="col-2">ì‹œê°„</div>
                <div class="col-9 text-start ps-3">ë°œì–¸ ë‚´ìš© (í´ë¦­í•˜ì—¬ ìˆ˜ì •)</div>
            </div>
        </div>
        <div class="card-body p-0">
            <div id="segmentList" class="list-group list-group-flush">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2 text-muted">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const SESSION_ID = '{{ session_id }}';
</script>

{% endblock %} {% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        loadDetail();
    });

    // 1. ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadDetail() {
        const token = localStorage.getItem('access_token');
        if (!token) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = '/login';
            return;
        }

        try {
            const response = await fetch(`/api/audio/${SESSION_ID}`, {
                headers: { Authorization: `Bearer ${token}` },
            });

            if (!response.ok) throw new Error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');

            const data = await response.json();

            const fileNameEl = document.getElementById('fileName');
            if (fileNameEl) fileNameEl.innerText = data.file_name;

            renderSegments(data.segments);
        } catch (error) {
            console.error(error);
            alert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // 2. ë¦¬ìŠ¤íŠ¸ ê·¸ë¦¬ê¸° (ê°ì • ë±ƒì§€ í¬í•¨)
    function renderSegments(segments) {
        const container = document.getElementById('segmentList');
        if (segments.length === 0) {
            container.innerHTML = `<div class="text-center py-5 text-muted">ë°ì´í„° ì—†ìŒ</div>`;
            return;
        }

        let html = '';
        segments.forEach((seg) => {
            const startFmt = formatTime(seg.start_time);
            const endFmt = formatTime(seg.end_time);
            const isCounselor = seg.speaker_label === 'counselor';

            const checkedAttr = isCounselor ? 'checked' : '';
            const rowClass = isCounselor ? 'bg-primary-subtle bg-opacity-10' : '';

            // ê°ì • ë±ƒì§€ ìƒì„±
            const emotionBadge = getEmotionBadge(seg.emotion_label, seg.emotion_confidence);

            html += `
                <div class="list-group-item list-group-item-action ${rowClass} segment-row" 
                     data-id="${seg.id}" id="row-${seg.id}">
                    
                    <div class="row align-items-center">
                        <div class="col-1 text-center">
                            <input type="checkbox" class="form-check-input speaker-checkbox" 
                                   style="transform: scale(1.3); cursor: pointer;"
                                   ${checkedAttr}
                                   onchange="toggleRowColor(${seg.id}, this.checked)">
                        </div>
                        <div class="col-2 text-muted small text-center">
                            ${startFmt} ~ ${endFmt}
                        </div>
                        <div class="col-9">
                            <div class="mb-1">${emotionBadge}</div>
                            <textarea class="form-control border-0 bg-transparent text-input" 
                                      rows="1" 
                                      style="resize: none; overflow: hidden; box-shadow: none;"
                                      oninput="autoResize(this)">${seg.text}</textarea>
                        </div>
                    </div>
                </div>
            `;
        });
        container.innerHTML = html;
        document.querySelectorAll('.text-input').forEach((el) => autoResize(el));
    }

    // 3. ê°ì • ë±ƒì§€ ìƒì„± í•¨ìˆ˜
    function getEmotionBadge(label, confidence) {
        if (!label) return '';

        const negative = ['ë¶ˆë§Œ', 'ë¶„ë…¸', 'ê²©ë¶„', 'ì§œì¦', 'ê²½ë¯¸í•œ ì§œì¦', 'ì‹¤ë§', 'ì¢Œì ˆ', 'ë¶ˆì•ˆ', 'í˜ì˜¤', 'í”¼ë¡œ'];
        const positive = ['ê°ì‚¬', 'ê¸°ì¨', 'í¥ë¶„', 'ìì‹ ê°', 'ì• ì •', 'ì¹œì ˆ'];

        let badgeClass = 'bg-secondary';
        let icon = '';

        if (negative.includes(label)) {
            badgeClass = 'bg-danger';
            icon = 'ğŸ”¥ ';
        } else if (positive.includes(label)) {
            badgeClass = 'bg-primary';
            icon = 'ğŸ€ ';
        }

        const confPercent = confidence ? `(${Math.round(confidence * 100)}%)` : '';

        return `<span class="badge ${badgeClass} rounded-pill mb-1">
                    ${icon}${label} ${confPercent}
                </span>`;
    }

    // 4. ì €ì¥ ë° ë¶„ì„ ë¡œì§
    async function saveChanges() {
        const token = localStorage.getItem('access_token');
        const saveBtn = document.querySelector('button[onclick="saveChanges()"]');

        saveBtn.disabled = true;
        saveBtn.innerText = 'ğŸ’¾ ì €ì¥ ì¤‘...';

        const rows = document.querySelectorAll('.segment-row');
        const updateData = [];
        rows.forEach((row) => {
            const id = parseInt(row.getAttribute('data-id'));
            const isChecked = row.querySelector('.speaker-checkbox').checked;
            const textValue = row.querySelector('.text-input').value;
            updateData.push({ id, text: textValue, is_counselor: isChecked });
        });

        try {
            // A. ì €ì¥ ìš”ì²­
            const saveRes = await fetch(`/api/audio/${SESSION_ID}/confirm`, {
                method: 'POST',
                headers: { Authorization: `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ segments: updateData }),
            });

            if (!saveRes.ok) throw new Error('ì €ì¥ ì‹¤íŒ¨');

            // B. ê°ì • ë¶„ì„ ìš”ì²­
            saveBtn.innerText = 'ğŸ¤– ê°ì • ë¶„ì„ ì¤‘...';
            const emotionRes = await fetch(`/api/emotion/${SESSION_ID}/analyze`, {
                method: 'POST',
                headers: { Authorization: `Bearer ${token}` },
            });

            if (!emotionRes.ok) throw new Error('ê°ì • ë¶„ì„ ì‹¤íŒ¨');

            const emotionData = await emotionRes.json();

            alert(`âœ… ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\në¶„ì„ëœ ë¬¸ì¥: ${emotionData.analyzed_count}ê°œ`);
            window.location.reload();
        } catch (error) {
            console.error(error);
            alert('ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
            saveBtn.disabled = false;
            saveBtn.innerText = 'ğŸ’¾ ì €ì¥ ë° ì™„ë£Œ';
        }
    }

    function autoResize(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
    }

    window.toggleRowColor = function (id, isChecked) {
        const row = document.getElementById(`row-${id}`);
        if (isChecked) row.classList.add('bg-primary-subtle', 'bg-opacity-10');
        else row.classList.remove('bg-primary-subtle', 'bg-opacity-10');
    };

    function formatTime(seconds) {
        const m = Math.floor(seconds / 60);
        const s = Math.floor(seconds % 60);
        return `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
    }
</script>
{% endblock %}
