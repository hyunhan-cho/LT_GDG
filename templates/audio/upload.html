{% extends 'base.html' %} {% block title %}íŒŒì¼ ì—…ë¡œë“œ - LinguaTech{% endblock %} {% block content %}
<div class="row justify-content-center mt-5">
    <div class="col-md-6">
        <div class="card shadow-lg border-0">
            <div class="card-body p-5 text-center">
                <h3 class="fw-bold text-primary mb-3">ğŸ“‚ í†µí™” ë…¹ìŒ ì—…ë¡œë“œ</h3>
                <p class="text-muted mb-4">WAV, MP3, M4A íŒŒì¼ì„ ì§€ì›í•©ë‹ˆë‹¤.</p>

                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="mb-4 text-start">
                        <label for="audioFile" class="form-label fw-bold">íŒŒì¼ ì„ íƒ</label>
                        <input
                            type="file"
                            class="form-control form-control-lg"
                            id="audioFile"
                            name="file"
                            accept="audio/*"
                            required
                        />
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg shadow-sm" id="uploadBtn">
                            ğŸš€ ë¶„ì„ ì‹œì‘í•˜ê¸°
                        </button>
                    </div>
                </form>

                <div id="progressArea" class="d-none mt-4">
                    <p class="mb-2 fw-bold text-primary">íŒŒì¼ ì—…ë¡œë“œ ë° ë¶„ì„ ì¤€ë¹„ ì¤‘...</p>
                    <div class="progress" style="height: 10px">
                        <div
                            class="progress-bar progress-bar-striped progress-bar-animated"
                            role="progressbar"
                            style="width: 100%"
                        ></div>
                    </div>
                </div>

                <div id="resultArea" class="d-none mt-4 alert alert-success text-start">
                    <h5 class="alert-heading fw-bold"><i class="bi bi-check-circle-fill"></i> ì—…ë¡œë“œ ì„±ê³µ!</h5>
                    <p class="mb-1">ë¶„ì„ ì„¸ì…˜ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                    <p class="small text-muted mb-3">Session ID: <strong id="sessionId"></strong></p>

                    <div class="d-flex gap-2">
                        <a href="/" class="btn btn-outline-success btn-sm">ğŸ  ë©”ì¸ìœ¼ë¡œ</a>
                        <a id="detailBtn" href="#" class="btn btn-success btn-sm shadow-sm"> ğŸ“ ê²°ê³¼ ë³´ì •í•˜ê¸° </a>
                    </div>
                </div>

                <div id="errorArea" class="d-none mt-4 alert alert-danger"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %} {% block extra_js %}
<script>
    document.getElementById('uploadForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        // ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
        const fileInput = document.getElementById('audioFile');
        const uploadBtn = document.getElementById('uploadBtn');
        const progressArea = document.getElementById('progressArea');
        const resultArea = document.getElementById('resultArea');
        const sessionIdEl = document.getElementById('sessionId'); // ğŸ‘ˆ ì—¬ê¸°!
        const detailBtn = document.getElementById('detailBtn'); // ğŸ‘ˆ ì—¬ê¸°!
        const errorArea = document.getElementById('errorArea');

        // íŒŒì¼ ì—†ìœ¼ë©´ ì¤‘ë‹¨
        if (!fileInput.files[0]) {
            alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }

        // í† í° í™•ì¸
        const token = localStorage.getItem('access_token');
        if (!token) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = '/login';
            return;
        }

        // UI ìƒíƒœ ë³€ê²½ (ë¡œë”© ì‹œì‘)
        uploadBtn.disabled = true;
        uploadBtn.innerText = 'â³ ì—…ë¡œë“œ ì¤‘...';
        progressArea.classList.remove('d-none');
        resultArea.classList.add('d-none');
        errorArea.classList.add('d-none');

        // ë°ì´í„° ì¤€ë¹„
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        try {
            const response = await fetch('/api/audio/upload', {
                method: 'POST',
                headers: {
                    Authorization: `Bearer ${token}`,
                    // ì£¼ì˜: FormData ì“¸ ë• 'Content-Type' í—¤ë”ë¥¼ ì§ì ‘ ì„¤ì •í•˜ë©´ ì•ˆ ë¨ (ë¸Œë¼ìš°ì €ê°€ ì•Œì•„ì„œ í•¨)
                },
                body: formData,
            });

            const data = await response.json();

            if (response.ok) {
                // âœ… ì„±ê³µ ì‹œ ì²˜ë¦¬
                progressArea.classList.add('d-none'); // ë¡œë”© ìˆ¨ê¹€
                resultArea.classList.remove('d-none'); // ê²°ê³¼ ë³´ì„

                // 1. ì„¸ì…˜ ID í…ìŠ¤íŠ¸ ë„£ê¸° (ì—ëŸ¬ ë‚¬ë˜ ë¶€ë¶„)
                if (sessionIdEl) sessionIdEl.innerText = data.session_id;

                // 2. ë²„íŠ¼ ë§í¬ ì—°ê²°
                if (detailBtn) detailBtn.href = `/audio/detail/${data.session_id}/`;

                uploadBtn.innerText = 'ì™„ë£Œ';
            } else {
                throw new Error(data.message || 'ì—…ë¡œë“œ ì‹¤íŒ¨');
            }
        } catch (error) {
            console.error(error);
            progressArea.classList.add('d-none');
            errorArea.classList.remove('d-none');
            errorArea.innerText = `âŒ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`;

            uploadBtn.disabled = false;
            uploadBtn.innerText = 'ğŸš€ ë¶„ì„ ì‹œì‘í•˜ê¸°';
        }
    });
</script>
{% endblock %}
