{% extends 'base.html' %} {% block title %}ë¶„ì„ ì—…ë¡œë“œ - LinguaTech{% endblock %} {% block content %}
<div class="row justify-content-center mt-5">
    <div class="col-md-8">
        <div class="card shadow">
            <div class="card-header bg-white py-3">
                <h4 class="mb-0">ğŸ“‚ ë…¹ìŒ íŒŒì¼ ì—…ë¡œë“œ</h4>
            </div>
            <div class="card-body p-5">
                <form id="uploadForm">
                    <div
                        class="mb-4 text-center p-5 border border-2 border-dashed rounded"
                        id="dropZone"
                        style="background-color: #f8f9fa; border-color: #dee2e6"
                    >
                        <p class="display-4">ğŸ§</p>
                        <h5>íŒŒì¼ì„ ì´ê³³ì— ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì„¸ìš”</h5>
                        <p class="text-muted small">ì§€ì› í˜•ì‹: .mp3, .m4a, .wav</p>
                        <input type="file" id="fileInput" class="d-none" accept=".mp3,.m4a,.wav" required />
                    </div>

                    <div id="progressArea" class="d-none mb-4">
                        <label class="form-label">ì—…ë¡œë“œ ë° ë¶„ì„ ì¤‘...</label>
                        <div class="progress">
                            <div
                                class="progress-bar progress-bar-striped progress-bar-animated"
                                role="progressbar"
                                style="width: 100%"
                            ></div>
                        </div>
                        <small class="text-muted">íŒŒì¼ í¬ê¸°ì— ë”°ë¼ ì‹œê°„ì´ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</small>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg" id="uploadBtn" disabled>ë¶„ì„ ì‹œì‘</button>
                    </div>
                </form>

                <div id="resultArea" class="d-none mt-4 alert alert-success">
                    <h5>âœ… ë¶„ì„ ì™„ë£Œ!</h5>
                    <p>ì„¸ì…˜ ID: <strong id="sessionId"></strong></p>
                    <p>ë¶„ì„ëœ ë¬¸ì¥ ìˆ˜: <span id="segmentCount"></span>ê°œ</p>
                    <hr />
                    <a href="/" class="btn btn-outline-success btn-sm">ë©”ì¸ìœ¼ë¡œ</a>
                    <a href="#" class="btn btn-success btn-sm">ìƒì„¸ ê²°ê³¼ ë³´ê¸° (ì¤€ë¹„ì¤‘)</a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %} {% block extra_js %}
<script>
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadForm = document.getElementById('uploadForm');

    // 1. ë“œë˜ê·¸ ì•¤ ë“œë¡­ & í´ë¦­ ì´ë²¤íŠ¸
    dropZone.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', function () {
        if (this.files.length > 0) {
            dropZone.querySelector('h5').innerText = 'ì„ íƒë¨: ' + this.files[0].name;
            dropZone.classList.add('border-primary');
            uploadBtn.disabled = false;
        }
    });

    // 2. ì—…ë¡œë“œ ì²˜ë¦¬
    uploadForm.addEventListener('submit', async function (e) {
        e.preventDefault();

        const file = fileInput.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('file', file);

        // UI ë³€ê²½ (ë¡œë”© ì¤‘)
        document.getElementById('progressArea').classList.remove('d-none');
        uploadBtn.disabled = true;
        dropZone.style.opacity = '0.5';

        const token = localStorage.getItem('access_token');

        try {
            const response = await fetch('/api/audio/upload', {
                method: 'POST',
                headers: {
                    Authorization: `Bearer ${token}`, // ì¸ì¦ í† í°
                },
                body: formData, // FormDataëŠ” Content-Type í—¤ë” ìë™ ì„¤ì •ë¨
            });

            const data = await response.json();

            if (response.ok) {
                // ì„±ê³µ ì²˜ë¦¬
                document.getElementById('progressArea').classList.add('d-none');
                document.getElementById('resultArea').classList.remove('d-none');

                document.getElementById('sessionId').innerText = data.session_id;
                document.getElementById('segmentCount').innerText = data.segments_count;
            } else {
                alert('ì‹¤íŒ¨: ' + (data.message || JSON.stringify(data)));
                location.reload();
            }
        } catch (error) {
            console.error('Error:', error);
            alert('ì˜¤ë¥˜ ë°œìƒ: ' + error);
            location.reload();
        }
    });
</script>
{% endblock %}
